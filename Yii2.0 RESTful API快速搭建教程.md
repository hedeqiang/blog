# Yii2 RESTful API 实战教程


这篇说下`yii2.0`开发 `API` 吧，使用 `RESTful` API模式

# 安装Yii2.0

## 通过 Composer 安装

这是安装Yii2.0的首选方法。如果你还没有安装 `Composer`，你可以按照[这里](https://getcomposer.org/doc/00-intro.md#installation-nix)的说明进行安装。

安装完 `Composer`，运行下面的命令来安装 [`Composer Asset`](https://github.com/francoispluchino/composer-asset-plugin) 插件:
```
php composer.phar global require "fxp/composer-asset-plugin:^1.2.0"
```

安装高级的应用程序模板，运行下面的命令：

```
php composer.phar create-project yiisoft/yii2-app-advanced advanced 2.0.13
```

# 初始化高级模板
```
cd advanced
init
```
# 修改数据库连接属性
打开 `common\config\main-local.php`,配置数据库连接信息
```
'db' => [
            'class' => 'yii\db\Connection',
            'dsn' => 'mysql:host=127.0.0.1;dbname=yiiapi',
            'username' => 'root',
            'password' => 'root',
            'charset' => 'utf8',
        ],
```

# 执行 `migrate ` 数据库迁移
```
yii migrate
```

# 拷贝backend目录，命名为api

打开`api\config\main.php` 修改`id`,`controllerNamespace`：
```
return [
    'id' => 'app-api',
    'basePath' => dirname(__DIR__),
    'controllerNamespace' => 'api\controllers',
]
```
打开`common\config\main.php`开启`url`路由美化规则
```
'urlManager' => [
            'enablePrettyUrl' => true,
            'showScriptName' => false,
            'rules' => [
            ],
        ],
```

打开`common\config\bootstrap.php`添加以下别名
```
Yii::setAlias('@api', dirname(dirname(__DIR__)) . '/api');
```

# 为什么要单独创建API应用
单独创建API应用，目的是便于维护，可以避免以下问题

* 配置的冲突
* 控制器的命名不便
* url美化规则冲突
* 分工明确`frontend`为前台目录；`backend`为后台目录；`api`为api目录


接下来打开 `api\controllers` 新建一个User控制器，继承 `yii\rest\ActiveController`，命名为 `UserController`,代码如下：
```php
<?php
namespace api\controllers;
use yii\rest\ActiveController;

class UserController extends ActiveController
{
    public $modelClass = 'common\models\User';
    
}

```
这里创建 `user`控制器继承 `yii\rest\ActiveController` 并指定要操作的模型

# 启用JSON 输入
配置 `request` 应用程序组件的 `parsers` 属性使用 `yii\web\JsonParser` 用于 `JSON` 输入

打开配置文件 `api\config\main-local.php` 修改为如下代码:
```
<?php

$config = [
    'components' => [
        'request' => [
            // !!! insert a secret key in the following (if it is empty) - this is required by cookie validation
            'cookieValidationKey' => 'P0r2XoT9LCUnyVlSgxBbJOqQxdCJ3i29',
            'parsers' => [
                'application/json' => 'yii\web\JsonParser',

            ],
        ],
    ],
];

if (!YII_ENV_TEST) {
    // configuration adjustments for 'dev' environment
    $config['bootstrap'][] = 'debug';
    $config['modules']['debug'] = [
        'class' => 'yii\debug\Module',
    ];

    $config['bootstrap'][] = 'gii';
    $config['modules']['gii'] = [
        'class' => 'yii\gii\Module',
    ];
}

return $config;

```

# 配置URL规则
为刚才的 `user`控制器添加url美化规则

打开 `api\config\main.php` 修改 `components`属性，添加下列代码:
```
...
'urlManager' => [
    'enablePrettyUrl' => true,
    'enableStrictParsing' => true,
    'showScriptName' => false,
    'rules' => [
        ['class' => 'yii\rest\UrlRule', 
        'controller' => 'user'
        ],
    ],
]

...
```

ok，到此就成了一个 符合 `RESTful` 风格的API
看起来在控制器了什么也没有写，只是指定了一个模型，但是她的背后完成了很多的功能哦，列表如下：

* `GET /users`: 逐页列出所有用户
* `HEAD /users`: 显示用户列表的概要信息
* `POST /users`: 创建一个新用户
* `GET /users/123`: 返回用户 123 的详细信息
* `HEAD /users/123`: 显示用户 123 的概述信息
* `PATCH /users/123`: and PUT /users/123: 更新用户123
* `DELETE /users/123`: 删除用户123
* `OPTIONS /users`: 显示关于末端 /users 支持的动词
* `OPTIONS /users/123`: 显示有关末端 /users/123 支持的动词


# 如何访问呢
你可以使用 `curl`命令进行访问,命令如下:
```
curl -i -H "Accept:application/json" "http://localhost/users"
```
命令行下还是比较麻烦的，也不方便测试，推荐使用 `API`测试工具

这类的工具有很多，我就不一一列举了，这里推荐 `Postman`,很好很强大，`Chorme`也有插件，可以安装，这里我推荐直接下载软件安装调试，比较方便

你可能发现了  访问任何路由地址都是加的`s`,`users` ， 为什么呢? `资源`，你要理解 `资源`二字，既然是资源肯定是个集合，肯定有一大堆，所以要加上复数，我是这么理解的。

你说我就是不想加上`s`,我就想采用`http://localhost/user` 这种方式来进行访问，好吧，可以，满足你，**只是不推荐**

继续打开配置文件`api\config\main.php`修改刚才添加的 `urlManager` 如下:

```
'urlManager' => [
    'enablePrettyUrl' => true,
    'enableStrictParsing' => true,
    'showScriptName' => false,
    'rules' => [
        ['class' => 'yii\rest\UrlRule', 
        'controller' => 'user',
        'pluralize' => false,    //设置为false 就可以去掉复数形式了
        ],
    ],
]
```
加入 `'pluralize' => false,` 就表示去掉复数形式了，再次强调**不推荐**

ok，在控制器中我们没有写任何一句代码，他就给我们生成许多方法，但是有时候我们可能需要修改一些代码，来达到我们想要的效果，比如连表查询，然后再返回数据

接下来我们就实现这样的功能:

打开刚才新建的`user`控制器, 重写 `action`方法:
```php
<?php

namespace api\controllers;
use yii\rest\ActiveController;

class UserController extend extends ActiveController
{
    public $modelClass = 'common\models\User';
    
    public function actions()
    {
        $action= parent::actions(); // TODO: Change the autogenerated stub
        unset($action['index']);
        unset($action['create']);
        unset($action['update']);
        unset($action['delete']);
    }
    
    public function actionIndex()
    {
        //你的代码
    }
    
}

```
这样我们就可以重写他的代码了。哈哈

我们再新建一个自己的 `action`

```
<?php

namespace api\controllers;
use yii\rest\ActiveController;

class UserController extend extends ActiveController
{
    public $modelClass = 'common\models\User';
    
    public function actions()
    {
        $action= parent::actions(); // TODO: Change the autogenerated stub
        unset($action['index']);
        unset($action['create']);
        unset($action['update']);
        unset($action['delete']);
    }
    
    public function actionIndex()
    {
        //你的代码
    }
    
    public function actionSendEmail()  //假如是get请求
    {
        //业务逻辑
    }
    
}
```
然后试着访问一下 `http://localhost/users/send-email`，报错？找不到？

报错就对了，那是因为我们没有设置其他路由访问

修改 `api\config\main.php`
```
'urlManager' => [
    'enablePrettyUrl' => true,
    'enableStrictParsing' => true,
    'showScriptName' => false,
    'rules' => [
        ['class' => 'yii\rest\UrlRule', 
        'controller' => 'user',
        //'pluralize' => false,    //设置为false 就可以去掉复数形式了
        'extraPatterns'=>[
            'GET send-email'=>'send-email'
        ],
        ],
    ],
]
```

接下来重新访问就没有问题了，ps：你自己编写的任何 `action` 都要在 `extraPatterns` 进行配置

差点忘了 `状态码` 这个东西，我们现在所有的东西返回来的都是一个 `JSON`,加入没有数据局返回的是空的数组，所以这肯定不行啊，我们得加上 一些特定的状态码 来标识这些数据啊，怎么加?

继续修改 `api\config\main.php` 在 `components` 添加如下代码:
```
'response' => [
            'class' => 'yii\web\Response',
            'on beforeSend' => function ($event) {
                $response = $event->sender;
                $response->data = [
                    'success' => $response->isSuccessful,
                    'code' => $response->getStatusCode(),
                    'message' => $response->statusText,
                    'data' => $response->data,
                ];
                $response->statusCode = 200;
            },
        ],

```
这里统一使用 `200`来表示,当然并不是所有的都是 200,你应该具体情况具体对待,切记不要乱使用 任意加各种标识，请 遵循这些 规范 [状态码](https://httpstatuses.com/)


是不是觉得还少了点什么？`认证` 对就是 `认证`，就差 `认证` 就完美了，篇幅有限，内容多了反而影响阅读兴趣，下篇进行 `认证`介绍

感谢以下，特别是 **魏曦**老师的视频教程

[魏曦教你学](http://www.weixistyle.com/api.php)

[Yii Framework 2.0 权威指南](http://www.yiichina.com/doc/guide/2.0/rest-quick-start)


不足之处，欢迎指正













